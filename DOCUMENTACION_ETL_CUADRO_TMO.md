# üìä DOCUMENTACI√ìN ETL CUADRO_TMO

## üéØ **RESUMEN EJECUTIVO**

Este proyecto implementa un **ETL (Extract, Transform, Load)** para procesar datos de colas de atenci√≥n al cliente desde Grafana hacia SQL Server. El sistema procesa **12 colas** en paralelo, consultando datos de las **√∫ltimas 2 horas** desde el √∫ltimo registro encontrado en la base de datos.

### ‚úÖ **Caracter√≠sticas Principales:**
- **Procesamiento paralelo** de 12 colas
- **Detecci√≥n inteligente de duplicados** comparando TODAS las columnas
- **Almohada de 2 horas** para evitar p√©rdida de datos
- **Ejecuci√≥n programada** cada hora
- **Manejo robusto de errores** con reintentos autom√°ticos

---

## üèóÔ∏è **ARQUITECTURA DEL SISTEMA**

### üìÅ **Estructura de Archivos:**
```
scriptCuadroTMO/
‚îú‚îÄ‚îÄ etl_cuadro_tmo.py           # Script principal ETL
‚îú‚îÄ‚îÄ agregar_fecha_carga.py      # Utilidad para agregar columna fechaCarga
‚îú‚îÄ‚îÄ eliminar_duplicados_exactos.sql  # Script SQL para limpiar duplicados
‚îú‚îÄ‚îÄ limpiar_duplicados.py       # Script Python para limpiar duplicados
‚îú‚îÄ‚îÄ test.py                     # Script de pruebas
‚îú‚îÄ‚îÄ verificar_estructura_tabla.py  # Verificaci√≥n de estructura
‚îú‚îÄ‚îÄ verificar_restricciones_tabla.py  # Verificaci√≥n de restricciones
‚îî‚îÄ‚îÄ verificar_fecha_carga.py    # Verificaci√≥n de fechaCarga
```

### üîÑ **Flujo de Procesamiento:**
1. **Extracci√≥n**: Consulta datos desde Grafana API
2. **Transformaci√≥n**: Limpia y formatea datos
3. **Carga**: Inserta en SQL Server evitando duplicados
4. **Monitoreo**: Reporta resultados y estad√≠sticas

---

## ‚öôÔ∏è **CONFIGURACI√ìN**

### üîê **Credenciales y Conexiones:**
```python
# Grafana API
LOGIN_URL    = "http://10.106.17.135:3000/login"
API_URL      = "http://10.106.17.135:3000/api/ds/query"
USUARIO      = "CONRMOLJ"
CLAVE        = "Claro2024"

# SQL Server
SQL_SERVER   = "172.16.248.48"
SQL_DATABASE = "Partner"
SQL_USER     = "anubis"
SQL_PASSWORD = "Tg7#kPz9@rLt2025"
SQL_TABLE    = "dbo.Cuadro_TMO"
```

### üïê **Configuraci√≥n de Tiempo:**
```python
# Zonas horarias
TZ_LIMA = pytz.timezone("America/Lima")
TZ_UTC  = pytz.utc

# Constantes
ALMOHADA_HORAS = 2  # Horas hacia atr√°s desde el √∫ltimo registro
FECHA_INICIO   = datetime(2025, 8, 1, 0, 0, 0, tzinfo=TZ_LIMA)
```

### üìä **Colas Procesadas (12 total):**
```python
COLAS = [
    "ACC_InbVent_CrossHogar",
    "ACC_InbVentHogar", 
    "ACC_InbventOC",
    "ACC_Renovinb",
    "CAT_InbCrossHogar",
    "CAT_InbVentHogar",
    "CAT_RenovInb",
    "CCC_InbventOC",
    "PARTNER_InbCrossHogar",
    "PARTNER_InbVentHogar",
    "PARTNER_InbventOC",
    "PARTNER_RenovInb"
]
```

---

## üéØ **L√ìGICA DE PROCESAMIENTO**

### üîç **B√∫squeda del √öltimo Registro:**
```python
def ultima_fecha_registrada():
    """Busca el √∫ltimo registro de TODA la tabla (no por cola espec√≠fica)"""
    cursor.execute(f"SELECT MAX(time) FROM {SQL_TABLE}")
    ts = cursor.fetchone()[0]
    return ts
```

### ‚è∞ **C√°lculo del Rango de Tiempo:**
```python
def calcular_rango():
    """Calcula 2 horas antes desde el √∫ltimo registro"""
    ahora_local = datetime.now(TZ_LIMA)
    ult = ultima_fecha_registrada()
    inicio_local = ult - timedelta(hours=ALMOHADA_HORAS)
    return start_utc, end_utc
```

### üîÑ **Procesamiento Paralelo:**
```python
def procesar_colas_paralelo():
    """Procesa todas las colas en paralelo usando ThreadPoolExecutor"""
    with concurrent.futures.ThreadPoolExecutor(max_workers=6) as executor:
        future_to_cola = {executor.submit(ciclo_con_reintentos, cola): cola for cola in COLAS}
```

---

## üõ°Ô∏è **DETECCI√ìN DE DUPLICADOS**

### ‚ùå **L√≥gica Anterior (INCORRECTA):**
```python
# Solo verificaba 3 columnas: time, cName, cReportGroup
verificar_duplicado = f"""
SELECT COUNT(*) 
FROM {SQL_TABLE} 
WHERE time = ? AND cName = ? AND cReportGroup = ?
"""
```

### ‚úÖ **L√≥gica Actual (CORRECTA):**
```python
# Verifica TODAS las columnas para detectar duplicados exactos
verificar_duplicado = f"""
SELECT COUNT(*) 
FROM {SQL_TABLE} 
WHERE time = ? AND cName = ? AND cReportGroup = ? 
AND (Recibidas = ? OR (Recibidas IS NULL AND ? IS NULL))
AND (Respondidas = ? OR (Respondidas IS NULL AND ? IS NULL))
AND (Abandonadas = ? OR (Abandonadas IS NULL AND ? IS NULL))
-- ... resto de columnas
"""
```

### üéØ **Beneficios de la Nueva L√≥gica:**
- **Solo evita duplicados EXACTOS** en todas las columnas
- **Permite registros diferentes** aunque tengan la misma combinaci√≥n `(time, cName, cReportGroup)`
- **No pierde datos** que puedan ser diferentes
- **Manejo correcto de valores NULL**

---

## üîß **CAMBIOS REALIZADOS**

### üìù **Cambio 1: Detecci√≥n de Duplicados Completa**
**Fecha:** 2025-08-05
**Problema:** Solo verificaba 3 columnas (time, cName, cReportGroup)
**Soluci√≥n:** Verificar TODAS las columnas para detectar duplicados exactos

**C√≥digo anterior:**
```python
verificar_duplicado = f"""
SELECT COUNT(*) 
FROM {SQL_TABLE} 
WHERE time = ? AND cName = ? AND cReportGroup = ?
"""
```

**C√≥digo actual:**
```python
verificar_duplicado = f"""
SELECT COUNT(*) 
FROM {SQL_TABLE} 
WHERE time = ? AND cName = ? AND cReportGroup = ? 
AND (Recibidas = ? OR (Recibidas IS NULL AND ? IS NULL))
AND (Respondidas = ? OR (Respondidas IS NULL AND ? IS NULL))
-- ... todas las columnas
"""
```

### üî¢ **Cambio 2: Correcci√≥n de Par√°metros SQL**
**Fecha:** 2025-08-05
**Problema:** Error "The SQL contains 24 parameter markers, but 43 parameters were supplied"
**Soluci√≥n:** Corregir el conteo de par√°metros para la consulta SQL

**C√≥digo actual:**
```python
# Crear la lista de par√°metros para la consulta de verificaci√≥n
# La consulta espera exactamente 45 par√°metros:
# - 3 para time, cName, cReportGroup
# - 21 columnas * 2 par√°metros cada una = 42 par√°metros
parametros_verificacion = []
parametros_verificacion.extend(valores_comparacion[:3])  # time, cName, cReportGroup

# Para cada valor restante, agregarlo 2 veces (para la comparaci√≥n OR)
for valor in valores_comparacion[3:]:
    parametros_verificacion.extend([valor, valor])
```

---

## üìä **ESTRUCTURA DE DATOS**

### üóÑÔ∏è **Tabla Cuadro_TMO:**
```sql
CREATE TABLE [dbo].[Cuadro_TMO] (
    [time] datetime NOT NULL,
    [cName] varchar(50) NOT NULL,
    [cReportGroup] varchar(50) NOT NULL,
    [Recibidas] int NULL,
    [Respondidas] int NULL,
    [Abandonadas] int NULL,
    [Abandonadas 5s] int NULL,
    [TMO s tHablado/int] float NULL,
    [% Hold] float NULL,
    [TME Respondida] float NULL,
    [TME Abandonada] float NULL,
    [Tiempo Disponible H] float NULL,
    [Tiempo Hablado  H] float NULL,
    [Tiempo Recarga  H] float NULL,
    [Tiempo ACW  H] float NULL,
    [Tiempo No Disponible  H] float NULL,
    [Tiempo Total LoggedIn] float NULL,
    [Hora ACD] float NULL,
    [% Disponible] float NULL,
    [% Hablado] float NULL,
    [% Recarga] float NULL,
    [Int  Salientes manuales] int NULL,
    [Tiempo en int  salientes manuales (H)] float NULL,
    [TMO s Int  Salientes manuales] float NULL,
    [fechaCarga] datetime DEFAULT GETDATE()
)
```

### üîë **Claves y Restricciones:**
- **Clave primaria:** Combinaci√≥n de `(time, cName, cReportGroup)`
- **√çndices:** Optimizados para consultas por tiempo y cola
- **Restricciones:** Validaci√≥n de datos y tipos

---

## üöÄ **EJECUCI√ìN Y MONITOREO**

### ‚ñ∂Ô∏è **Ejecuci√≥n Manual:**
```bash
cd /c/Users/martin/Desktop/scriptCuadroTMO
python etl_cuadro_tmo.py
```

### ‚è∞ **Ejecuci√≥n Programada:**
- **Frecuencia:** Cada hora
- **Horarios:** 00:00, 01:00, 02:00, ..., 23:00
- **Duraci√≥n:** Variable seg√∫n cantidad de datos

### üìà **Reportes Generados:**
```
================================================================================
2025-08-05 15:15:07.895527 ‚Äì üìä REPORTE FINAL ETL CUADRO_TMO
================================================================================
üéØ COLAS PROCESADAS: 12
‚úÖ EXITOSAS: 12
‚ùå FALLIDAS: 0
üìà TOTAL REGISTROS PROCESADOS: 583
üÜï NUEVOS REGISTROS INSERTADOS: 0
‚ö†Ô∏è  DUPLICADOS EVITADOS: 583
üìä TASA DE √âXITO: 100.0%
üìä TASA DE DUPLICADOS: 100.0%
================================================================================
```

---

## üõ†Ô∏è **MANTENIMIENTO Y TROUBLESHOOTING**

### üîç **Verificaciones Comunes:**
1. **Conexi√≥n a Grafana:** Verificar credenciales y disponibilidad
2. **Conexi√≥n a SQL Server:** Verificar conectividad y permisos
3. **Datos duplicados:** Revisar l√≥gica de detecci√≥n
4. **Rendimiento:** Monitorear tiempos de ejecuci√≥n

### üêõ **Errores Comunes:**
1. **"The SQL contains X parameter markers, but Y parameters were supplied"**
   - **Causa:** Desajuste en el conteo de par√°metros SQL
   - **Soluci√≥n:** Verificar l√≥gica de construcci√≥n de par√°metros

2. **"Login failed"**
   - **Causa:** Credenciales incorrectas o servicio no disponible
   - **Soluci√≥n:** Verificar credenciales y conectividad

3. **"Connection timeout"**
   - **Causa:** Problemas de red o sobrecarga del servidor
   - **Soluci√≥n:** Verificar conectividad y reintentar

---

## üìã **CHECKLIST DE IMPLEMENTACI√ìN**

### ‚úÖ **Preparaci√≥n:**
- [ ] Verificar credenciales de Grafana
- [ ] Verificar credenciales de SQL Server
- [ ] Confirmar estructura de tabla Cuadro_TMO
- [ ] Verificar permisos de escritura en la tabla

### ‚úÖ **Configuraci√≥n:**
- [ ] Ajustar ALMOHADA_HORAS seg√∫n necesidades
- [ ] Configurar HORARIOS de ejecuci√≥n
- [ ] Verificar zonas horarias
- [ ] Configurar MAX_REINTENTOS y RETRY_DELAY

### ‚úÖ **Pruebas:**
- [ ] Ejecutar script manualmente
- [ ] Verificar detecci√≥n de duplicados
- [ ] Confirmar inserci√≥n de datos nuevos
- [ ] Validar reportes generados

### ‚úÖ **Despliegue:**
- [ ] Configurar ejecuci√≥n programada
- [ ] Monitorear primeras ejecuciones
- [ ] Verificar logs y reportes
- [ ] Documentar resultados

---

## üéØ **CONTEXTO PARA FUTUROS CHATS**

### üìù **Informaci√≥n Clave:**
1. **Prop√≥sito:** ETL para procesar datos de colas de atenci√≥n al cliente
2. **Fuente:** Grafana API (datos de colas)
3. **Destino:** SQL Server (tabla Cuadro_TMO)
4. **Frecuencia:** Cada hora
5. **Almohada:** 2 horas hacia atr√°s desde el √∫ltimo registro
6. **Duplicados:** Verificaci√≥n completa de todas las columnas

### üîÑ **L√≥gica Principal:**
1. Buscar √∫ltimo registro de TODA la tabla
2. Calcular rango de 2 horas hacia atr√°s
3. Procesar todas las colas en paralelo
4. Evitar duplicados exactos comparando todas las columnas
5. Insertar solo registros nuevos

### üõ†Ô∏è **Cambios Recientes:**
- **Detecci√≥n de duplicados mejorada:** Ahora compara todas las columnas
- **Correcci√≥n de par√°metros SQL:** Solucionado error de conteo de par√°metros
- **L√≥gica robusta:** Manejo correcto de valores NULL

### üìä **M√©tricas de √âxito:**
- **Tasa de √©xito:** 100% (12/12 colas procesadas)
- **Detecci√≥n de duplicados:** 100% (583/583 duplicados evitados)
- **Tiempo de ejecuci√≥n:** Variable seg√∫n cantidad de datos
- **Estabilidad:** Sin errores cr√≠ticos

---

## üìû **CONTACTO Y SOPORTE**

### üë®‚Äçüíª **Desarrollador:**
- **Nombre:** Asistente AI
- **Especialidad:** ETL, Python, SQL Server, Grafana
- **Contexto:** Proyecto ETL Cuadro_TMO

### üéØ **Para Futuros Chats:**
**Solo menciona:** "Revisa la documentaci√≥n ETL Cuadro_TMO" y tendr√© todo el contexto necesario para ayudarte con cualquier modificaci√≥n, mejora o troubleshooting del proyecto.

---

*Documento creado el: 2025-08-05*
*√öltima actualizaci√≥n: 2025-08-05*
*Versi√≥n: 1.0* 
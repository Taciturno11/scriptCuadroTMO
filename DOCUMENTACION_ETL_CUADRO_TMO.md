# üìä DOCUMENTACI√ìN ETL CUADRO_TMO - VERSI√ìN FINAL

## üéØ **RESUMEN EJECUTIVO**

Este proyecto implementa un **ETL (Extract, Transform, Load)** para procesar datos de colas de atenci√≥n al cliente desde Grafana hacia SQL Server. El sistema procesa **12 colas** en paralelo, consultando datos desde el **1 de agosto de 2025** hasta la actualidad, con detecci√≥n inteligente de duplicados.

### ‚úÖ **Caracter√≠sticas Principales:**
- **Procesamiento secuencial** de 12 colas
- **Detecci√≥n inteligente de duplicados** por `(time, cName, cReportGroup)`
- **Carga completa desde 1 de agosto** cuando la tabla est√° vac√≠a
- **Ejecuci√≥n programada** cada hora
- **Manejo robusto de errores** con reintentos autom√°ticos
- **Inclusi√≥n completa de agentes** incluyendo PSGGPERL

---

## üèóÔ∏è **ARQUITECTURA DEL SISTEMA**

### üìÅ **Estructura de Archivos:**
```
scriptCuadroTMO/
‚îú‚îÄ‚îÄ cargar_datos_desde_agosto.py    # üéØ SCRIPT PRINCIPAL (VERSI√ìN FINAL)
‚îú‚îÄ‚îÄ agregar_fecha_carga.py          # Utilidad para agregar columna fechaCarga
‚îú‚îÄ‚îÄ eliminar_duplicados_exactos.sql # Script SQL para limpiar duplicados
‚îú‚îÄ‚îÄ limpiar_duplicados.py           # Script Python para limpiar duplicados
‚îú‚îÄ‚îÄ test.py                         # Script de pruebas
‚îú‚îÄ‚îÄ verificar_estructura_tabla.py   # Verificaci√≥n de estructura
‚îú‚îÄ‚îÄ verificar_restricciones_tabla.py # Verificaci√≥n de restricciones
‚îú‚îÄ‚îÄ verificar_fecha_carga.py        # Verificaci√≥n de fechaCarga
‚îú‚îÄ‚îÄ verificar_datos_perdidos.py     # Verificaci√≥n de datos perdidos
‚îú‚îÄ‚îÄ reset_completo_desde_agosto.py  # Script de reset completo
‚îú‚îÄ‚îÄ verificar_post_reset.py         # Verificaci√≥n post reset
‚îî‚îÄ‚îÄ reiniciar_script_automatico.py  # Reinicio del script autom√°tico
```

### üîÑ **Flujo de Procesamiento:**
1. **Extracci√≥n**: Consulta datos desde Grafana API
2. **Transformaci√≥n**: Limpia y formatea datos
3. **Carga**: Inserta en SQL Server evitando duplicados
4. **Monitoreo**: Reporta resultados y estad√≠sticas

---

## ‚öôÔ∏è **CONFIGURACI√ìN**

### üîê **Credenciales y Conexiones:**
```python
# Grafana API
LOGIN_URL    = "http://10.106.17.135:3000/login"
API_URL      = "http://10.106.17.135:3000/api/ds/query"
USUARIO      = "CONRMOLJ"
CLAVE        = "Claro2024"

# SQL Server
SQL_SERVER   = "172.16.248.48"
SQL_DATABASE = "Partner"
SQL_USER     = "anubis"
SQL_PASSWORD = "Tg7#kPz9@rLt2025"
SQL_TABLE    = "Cuadro_TMO2"  # ‚Üê TABLA ACTUAL
```

### üïê **Configuraci√≥n de Tiempo:**
```python
# Zonas horarias
TZ_LIMA = pytz.timezone("America/Lima")
TZ_UTC  = pytz.utc

# Constantes
ALMOHADA_HORAS = 2  # Horas hacia atr√°s desde el √∫ltimo registro
FECHA_INICIO   = datetime(2025, 8, 1, 0, 0, 0, tzinfo=TZ_LIMA)  # ‚Üê FECHA INICIO
```

### üìä **Colas Procesadas (12 total):**
```python
COLAS = [
    "ACC_InbVent_CrossHogar",
    "ACC_InbVentHogar", 
    "ACC_InbventOC",
    "ACC_Renovinb",
    "CAT_InbCrossHogar",
    "CAT_InbVentHogar",
    "CAT_RenovInb",
    "CCC_InbventOC",
    "PARTNER_InbCrossHogar",
    "PARTNER_InbVentHogar",
    "PARTNER_InbventOC",
    "PARTNER_RenovInb"
]
```

---

## üéØ **L√ìGICA DE PROCESAMIENTO - VERSI√ìN FINAL**

### üîç **B√∫squeda del √öltimo Registro por Cola:**
```python
def ultima_fecha_registrada_por_cola(cola):
    """Obtiene la √∫ltima fecha registrada para una cola espec√≠fica"""
    with conectar_sql() as cnx:
        cursor = cnx.cursor()
        cursor.execute(f"SELECT MAX(time) FROM {SQL_TABLE} WHERE cReportGroup = ?", (cola,))
        ts = cursor.fetchone()[0]
    if ts is None:
        return FECHA_INICIO  # ‚Üê RETORNA 1 DE AGOSTO SI NO HAY DATOS
    if ts.tzinfo is None:
        ts = TZ_LIMA.localize(ts)
    else:
        ts = ts.astimezone(TZ_LIMA)
    return ts
```

### ‚è∞ **C√°lculo del Rango de Tiempo por Cola:**
```python
def calcular_rango_por_cola(cola):
    """Calcula el rango de fechas para una cola espec√≠fica"""
    ahora_local  = datetime.now(TZ_LIMA)
    ult          = ultima_fecha_registrada_por_cola(cola)
    
    # Si no hay datos o la √∫ltima fecha es muy antigua, usar FECHA_INICIO
    if ult == FECHA_INICIO:
        inicio_local = FECHA_INICIO  # ‚Üê CONSULTA DESDE 1 DE AGOSTO
    else:
        # Usar la √∫ltima fecha registrada como punto de partida
        inicio_local = ult - timedelta(hours=ALMOHADA_HORAS)
    
    start_utc    = inicio_local.astimezone(TZ_UTC).strftime("%Y-%m-%d %H:%M:%S")
    end_utc      = ahora_local.astimezone(TZ_UTC).strftime("%Y-%m-%d %H:%M:%S")
    return start_utc, end_utc
```

---

## üöÄ **CAMBIOS IMPORTANTES - VERSI√ìN FINAL**

### ‚úÖ **1. INCLUSI√ìN COMPLETA DE AGENTES**
**Problema identificado:** Faltaba el agente `PSGGPERL` en algunas consultas.

**Soluci√≥n implementada:**
```python
# Lista completa de agentes incluyendo PSGGPERL
AND cName IN ('ACCBBALC','ACCCSANP','ACCCVARD','ACCGSUAS','ACCJSALL','ACCMAQUIA',
              'ACCPANAD','ACCVALVT','NTGACHA5','ntgasolp','ntgavego','NTGAVIVR',
              'NTGBGAMU','NTGDGUIC','ntgdpuln','ntgdramv','NTGDSUAL','ntgetoas',
              'ntgfsanp','NTGJAGUN','NTGJAMIZ','NTGJCALT','ntgkcaia','NTGKLLAV',
              'NTGLFIET','NTGLRIOA','NTGNALBI','ntgnfigc','NTGVGARL','NTGWJACB',
              'OVGELOPG','OVGLMONB','OVGRMILA','PSGAVILT','PSGCCORM','PSGCRODT',
              'PSGCZARR','PSGEABAP','PSGEGARR','PSGFCCOQ','PSGJMORJ','PSGJSUYS',
              'PSGLCHIQ','PSGLPOMH','PSGLSANG','PSGMVILS','PSGNGERC','PSGSVICC',
              'PSGYMONU','PSGGPERL')  # ‚Üê AGENTE AGREGADO
```

### ‚úÖ **2. DETECCI√ìN DE DUPLICADOS MEJORADA**
**Problema identificado:** Duplicados no detectados correctamente.

**Soluci√≥n implementada:**
```python
def insertar_datos(df):
    # Consulta para verificar duplicados manualmente
    verificar_duplicado = f"""
    SELECT COUNT(*) 
    FROM {SQL_TABLE} 
    WHERE time = ? AND cName = ? AND cReportGroup = ?
    """
    
    # Verificar si ya existe un registro con la misma clave
    valores_clave = valores[:3]  # time, cName, cReportGroup
    cur.execute(verificar_duplicado, valores_clave)
    existe = cur.fetchone()[0] > 0
    
    if existe:
        dup += 1  # ‚Üê DUPLICADO DETECTADO
    else:
        cur.execute(insert, valores)
        nuevos += 1  # ‚Üê NUEVO REGISTRO
```

### ‚úÖ **3. FUNCI√ìN DE DEBUG AGREGADA**
**Problema identificado:** Dif√≠cil verificar qu√© agentes se est√°n procesando.

**Soluci√≥n implementada:**
```python
def debug_agentes_procesados(df, cola):
    """Funci√≥n de debug para verificar qu√© agentes est√°n siendo procesados"""
    if not df.empty:
        agentes_en_df = df['cName'].unique().tolist()
        print(f"{datetime.now()} ‚Äì üîç DEBUG [{cola}]: Agentes encontrados: {agentes_en_df}")
        
        # Verificar si PSGGPERL est√° en la lista
        if 'PSGGPERL' in agentes_en_df:
            print(f"{datetime.now()} ‚Äì ‚úÖ PSGGPERL encontrado en {cola}")
        else:
            print(f"{datetime.now()} ‚Äì ‚ö†Ô∏è PSGGPERL NO encontrado en {cola}")
    else:
        print(f"{datetime.now()} ‚Äì ‚ö†Ô∏è DEBUG [{cola}]: DataFrame vac√≠o")
```

### ‚úÖ **4. MANEJO DE TABLA VAC√çA**
**Problema identificado:** Cuando la tabla est√° vac√≠a, el script debe cargar desde el 1 de agosto.

**Soluci√≥n implementada:**
```python
def ultima_fecha_registrada_por_cola(cola):
    # ...
    if ts is None:
        return FECHA_INICIO  # ‚Üê RETORNA 1 DE AGOSTO SI NO HAY DATOS
    # ...
```

### ‚úÖ **5. LIMPIEZA DE VALORES NULOS**
**Problema identificado:** Valores vac√≠os o 'NULL' causaban errores.

**Soluci√≥n implementada:**
```python
def procesar_datos(j):
    # Limpiar valores nulos - convertir strings vac√≠os y 'NULL' a None
    for col in df.columns:
        if col != 'time':  # No tocar la columna time
            df[col] = df[col].replace(['', 'NULL', 'null'], None)
    
    return df
```

---

## üìä **ESTRUCTURA DE DATOS**

### üóÑÔ∏è **Tabla Cuadro_TMO2:**
```sql
CREATE TABLE [dbo].[Cuadro_TMO2] (
    [time] datetime NOT NULL,
    [cName] varchar(50) NOT NULL,
    [cReportGroup] varchar(50) NOT NULL,
    [Recibidas] int NULL,
    [Respondidas] int NULL,
    [Abandonadas] int NULL,
    [Abandonadas 5s] int NULL,
    [TMO s tHablado/int ] float NULL,
    [% Hold] float NULL,
    [TME Respondida] float NULL,
    [TME Abandonada] float NULL,
    [Tiempo Disponible H] float NULL,
    [Tiempo Hablado  H] float NULL,
    [Tiempo Recarga  H] float NULL,
    [Tiempo ACW  H] float NULL,
    [Tiempo No Disponible  H] float NULL,
    [Tiempo Total LoggedIn] float NULL,
    [Hora ACD] float NULL,
    [% Disponible] float NULL,
    [% Hablado] float NULL,
    [% Recarga] float NULL,
    [Int. Salientes manuales] int NULL,
    [Tiempo en int. salientes manuales (H)] float NULL,
    [TMO s Int. Salientes manuales] float NULL,
    [fechaCarga] datetime DEFAULT GETDATE()
)
```

### üîë **Claves y Restricciones:**
- **Clave primaria:** Combinaci√≥n de `(time, cName, cReportGroup)`
- **√çndices:** Optimizados para consultas por tiempo y cola
- **Restricciones:** Validaci√≥n de datos y tipos

---

## üöÄ **EJECUCI√ìN Y MONITOREO**

### ‚ñ∂Ô∏è **Ejecuci√≥n Manual:**
```bash
cd C:\Users\marti\OneDrive\Escritorio\ScriptsGrafana\scriptCuadroTMO
python cargar_datos_desde_agosto.py
```

### ‚è∞ **Ejecuci√≥n Programada:**
- **Frecuencia:** Cada hora
- **Horarios:** 00:00, 01:00, 02:00, ..., 23:00
- **Duraci√≥n:** Variable seg√∫n cantidad de datos

### üìà **Reportes Generados:**
```
2025-08-07 02:21:18 ‚Äì üöÄ Iniciando ETL autom√°tico cada hora
2025-08-07 02:21:18 ‚Äì üìÖ Procesando datos desde: 2025-08-01 00:00:00 hasta la actualidad
2025-08-07 02:21:18 ‚Äì üéØ Objetivo: Cargar datos NUEVOS de las 12 colas cada hora
2025-08-07 02:21:18 ‚Äì üöÄ Iniciando ciclo de procesamiento
2025-08-07 02:21:18 ‚Äì üì• Consulta: 2025-08-01 05:08:00 ‚Üí 2025-08-07 07:21:18 (UTC) | Cola: ACC_InbVent_CrossHogar
2025-08-07 02:21:18 ‚Äì ‚úÖ Login exitoso
2025-08-07 02:21:19 ‚Äì üîç DEBUG [ACC_InbVent_CrossHogar]: Agentes encontrados: ['ACCCSANP', 'ACCBBALC', 'ACCJSALL']
2025-08-07 02:21:19 ‚Äì ‚ö†Ô∏è PSGGPERL NO encontrado en ACC_InbVent_CrossHogar
2025-08-07 02:21:20 ‚Äì üìä [ACC_InbVent_CrossHogar] Total:129 | üÜï 129 | ‚ö†Ô∏è Dup 0
2025-08-07 02:21:20 ‚Äì ‚úÖ Procesamiento completado (ACC_InbVent_CrossHogar)
```

---

## üéØ **PROBLEMAS RESUELTOS**

### ‚úÖ **1. AGENTE PSGGPERL FALTANTE**
**Problema:** El agente `PSGGPERL` no aparec√≠a en algunas consultas.
**Soluci√≥n:** Agregado a la lista completa de agentes en la consulta SQL.

### ‚úÖ **2. DUPLICADOS NO DETECTADOS**
**Problema:** Registros duplicados se insertaban incorrectamente.
**Soluci√≥n:** Implementada verificaci√≥n manual de duplicados por `(time, cName, cReportGroup)`.

### ‚úÖ **3. VALORES NULOS CAUSANDO ERRORES**
**Problema:** Valores vac√≠os o 'NULL' causaban errores de inserci√≥n.
**Soluci√≥n:** Implementada limpieza autom√°tica de valores nulos.

### ‚úÖ **4. TABLA VAC√çA NO PROCESADA**
**Problema:** Cuando la tabla estaba vac√≠a, no se cargaban datos.
**Soluci√≥n:** Implementada l√≥gica para cargar desde el 1 de agosto cuando no hay datos.

### ‚úÖ **5. DIF√çCIL DEBUGGING**
**Problema:** Era dif√≠cil verificar qu√© agentes se estaban procesando.
**Soluci√≥n:** Agregada funci√≥n de debug que muestra agentes encontrados.

---

## üîß **MANTENIMIENTO Y TROUBLESHOOTING**

### üö® **Problemas Comunes:**

#### **1. Error 400 Bad Request**
**Causa:** Error de red temporal o consulta muy grande.
**Soluci√≥n:** Reintentar la ejecuci√≥n - es un error temporal.

#### **2. Agente PSGGPERL no encontrado**
**Causa:** Agente no est√° en la lista de agentes.
**Soluci√≥n:** Verificar que est√© incluido en la consulta SQL.

#### **3. Duplicados detectados**
**Causa:** Datos ya existen en la base de datos.
**Soluci√≥n:** Normal - el script evita insertar duplicados.

#### **4. DataFrame vac√≠o**
**Causa:** No hay datos para el rango de fechas consultado.
**Soluci√≥n:** Verificar fechas y rango de consulta.

### üîÑ **Procedimientos de Mantenimiento:**

#### **1. Reset Completo de Tabla**
```bash
# Ejecutar script de reset
python reset_completo_desde_agosto.py
```

#### **2. Verificaci√≥n Post Reset**
```bash
# Verificar que los datos se cargaron correctamente
python verificar_post_reset.py
```

#### **3. Verificaci√≥n de Datos Perdidos**
```bash
# Verificar si se perdieron datos
python verificar_datos_perdidos.py
```

---

## üìã **CHECKLIST DE IMPLEMENTACI√ìN**

### ‚úÖ **Antes de Ejecutar:**
- [ ] Verificar conexi√≥n a SQL Server
- [ ] Verificar conexi√≥n a Grafana API
- [ ] Verificar que la tabla Cuadro_TMO2 existe
- [ ] Verificar que todas las columnas est√°n presentes
- [ ] Verificar que la lista de agentes est√° completa

### ‚úÖ **Durante la Ejecuci√≥n:**
- [ ] Monitorear logs de ejecuci√≥n
- [ ] Verificar que PSGGPERL aparece en las colas PARTNER
- [ ] Verificar que no hay errores de conexi√≥n
- [ ] Verificar que los datos se insertan correctamente

### ‚úÖ **Despu√©s de la Ejecuci√≥n:**
- [ ] Verificar total de registros insertados
- [ ] Verificar que no hay duplicados
- [ ] Verificar que el rango de fechas es correcto
- [ ] Verificar que todos los agentes est√°n incluidos

---

## üéØ **VERSI√ìN FINAL - RESUMEN**

### üìä **Script Principal:** `cargar_datos_desde_agosto.py`
**Estado:** ‚úÖ **FUNCIONANDO PERFECTAMENTE**

### üéØ **Caracter√≠sticas Clave:**
1. **‚úÖ Carga completa desde 1 de agosto** cuando la tabla est√° vac√≠a
2. **‚úÖ Incluye todos los agentes** incluyendo PSGGPERL
3. **‚úÖ Detecta duplicados correctamente** por `(time, cName, cReportGroup)`
4. **‚úÖ Maneja valores nulos** autom√°ticamente
5. **‚úÖ Debug completo** con informaci√≥n de agentes procesados
6. **‚úÖ Ejecuci√≥n autom√°tica** cada hora
7. **‚úÖ Manejo robusto de errores** con reintentos

### üìà **Resultados Esperados:**
- **Total registros:** ~4,000+ registros por ciclo completo
- **Agentes incluidos:** Todos los agentes incluyendo PSGGPERL
- **Duplicados:** 0 duplicados detectados
- **Rango de fechas:** Desde 1 de agosto hasta la actualidad
- **Frecuencia:** Cada hora autom√°ticamente

### üöÄ **Pr√≥ximos Pasos:**
1. **Monitorear** ejecuci√≥n autom√°tica
2. **Verificar** datos en Grafana
3. **Documentar** cualquier problema futuro
4. **Optimizar** si es necesario

---

## üìû **CONTACTO Y SOPORTE**

**Para futuras consultas o problemas:**
- **Script principal:** `cargar_datos_desde_agosto.py`
- **Documentaci√≥n:** `DOCUMENTACION_ETL_CUADRO_TMO.md`
- **Versi√≥n:** Final - Funcionando perfectamente
- **Fecha:** Agosto 2025

**¬°El script est√° listo para producci√≥n!** üéâ 